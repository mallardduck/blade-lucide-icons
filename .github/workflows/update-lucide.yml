name: Update Icons

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  check_versions:
    runs-on: ubuntu-latest
    outputs:
      latest: ${{ steps.latest-version.outputs.LATEST_VERSION }}
      up_to_date: ${{ steps.current-version.outputs.CURRENT_VERSION == steps.latest-version.outputs.LATEST_VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Set current version
        id: current-version
        shell: bash
        run: |
          cd lucide
          git fetch --tags --force --quiet
          CURR_TAG="$(git describe --tags --abbrev=0)"
          echo "CURRENT_VERSION=${CURR_TAG}" >> "$GITHUB_OUTPUT"
          {
            echo "### Current Lucide submodule"
            echo ""
            echo "- Tag: \`${CURR_TAG}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Set latest version
        id: latest-version
        env:
          GITHUB_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          LATEST_TAG="$(gh release view -R lucide-icons/lucide --json tagName -q .tagName)"
          echo "LATEST_VERSION=${LATEST_TAG}" >> "$GITHUB_OUTPUT"
          {
            echo "### Upstream latest release"
            echo ""
            echo "- Tag: \`${LATEST_TAG}\`"
          } >> "$GITHUB_STEP_SUMMARY"

  update_icons:
    needs: [check_versions]
    runs-on: ubuntu-latest
    if: ${{ needs.check_versions.outputs.up_to_date == 'false' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: dom, curl, libxml, mbstring, zip
          coverage: none
          tools: composer

      - name: Install dependencies
        shell: bash
        run: composer install --prefer-dist --no-interaction --no-progress

      - name: Update submodule to latest tag
        shell: bash
        run: |
          cd lucide
          git fetch --all --tags --force --quiet
          git checkout "${{ needs.check_versions.outputs.latest }}"
          cd ..
          # Stage the submodule pointer update
          git add lucide

      - name: Run generator
        shell: bash
        run: php vendor/bin/blade-icons-generate

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          add: .
          message: "feat(icons): Update Lucide to ${{ needs.check_versions.outputs.latest }}"
          push: true
